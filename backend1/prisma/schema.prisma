generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// User authentication and profile
model User {
  id               Int            @id @default(autoincrement())
  email            String         @unique
  password         String
  name             String
  phoneNumber      String?
  department       String?
  profileImageUrl  String?
  coverImageUrl    String?
  isVerified       Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  collegeId        Int
  buyer            Buyer?
  itemComments     ItemComment[]
  mentee           Mentee?
  mentor           Mentor?
  receivedMessages Message[]      @relation("ReceivedMessages")
  sentMessages     Message[]      @relation("SentMessages")
  notifications    Notification[]
  otps             OTP[]
  refreshTokens    RefreshToken[]
  seller           Seller?
  tasks            Task[]
  college          College        @relation(fields: [collegeId], references: [id], onDelete: Cascade)

  @@index([email])
}

/// OTP for email verification
model OTP {
  id        Int      @id @default(autoincrement())
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
}

/// Refresh tokens for JWT
model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

/// Chat messages between users and mentors
model Message {
  id         Int      @id @default(autoincrement())
  content    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
  senderId   Int
  receiverId Int
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

/// ERD: College 1..* Student
model College {
  id       Int       @id @default(autoincrement())
  name     String
  location String
  students Student[]
  users    User[]
}

/// ERD: Student belongs to a College and is a supertype for Buyer/Seller/Mentor/Mentee
model Student {
  id          Int     @id @default(autoincrement())
  name        String
  email       String  @unique
  phoneNumber String?
  department  String?
  collegeId   Int
  buyer       Buyer?
  mentee      Mentee?
  mentor      Mentor?
  seller      Seller?
  college     College @relation(fields: [collegeId], references: [id], onDelete: Cascade)
}

/// ERD subtype: Buyer (ISA Student/User)
model Buyer {
  studentId Int?     @unique
  userId    Int      @id
  student   Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  purchases Item[]   @relation("BuyerPurchases")
  reviews   Review[]
}

/// ERD subtype: Seller (ISA Student/User)
model Seller {
  studentId Int?     @unique
  userId    Int      @id
  items     Item[]   @relation("SellerItems")
  student   Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// ERD subtype: Mentor (ISA Student/User)
model Mentor {
  studentId        Int?      @unique
  userId           Int       @id
  expertiseArea    String?
  student          Student?  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  requestsReceived Request[]
  reviews          Review[]
}

/// ERD subtype: Mentee (ISA Student/User)
model Mentee {
  studentId    Int?      @unique
  userId       Int       @id
  interestArea String?
  student      Student?  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  requestsSent Request[]
}

/// ERD: Category 1..* Item
model Category {
  id    Int    @id @default(autoincrement())
  name  String @unique
  items Item[]
}

/// ERD: Seller 1..* Items, Buyer 1..* Items (optional buyer until purchased)
model Item {
  id         Int           @id @default(autoincrement())
  itemName   String
  cost       Float
  condition  String
  imageUrl   String?
  sellerId   Int
  buyerId    Int?
  categoryId Int
  buyer      Buyer?        @relation("BuyerPurchases", fields: [buyerId], references: [userId])
  category   Category      @relation(fields: [categoryId], references: [id])
  seller     Seller        @relation("SellerItems", fields: [sellerId], references: [userId])
  comments   ItemComment[]
  reviews    Review[]

  @@index([sellerId])
  @@index([buyerId])
  @@index([categoryId])
}

/// Comments on marketplace items
model ItemComment {
  id        Int      @id @default(autoincrement())
  text      String
  createdAt DateTime @default(now())
  userId    Int
  itemId    Int
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([itemId])
}

/// ERD: Buyer 1..* Review
model Review {
  id       Int      @id @default(autoincrement())
  comments String?
  rating   Int
  date     DateTime @default(now())
  buyerId  Int
  itemId   Int?
  mentorId Int?
  buyer    Buyer    @relation(fields: [buyerId], references: [userId], onDelete: Cascade)
  item     Item?    @relation(fields: [itemId], references: [id], onDelete: Cascade)
  mentor   Mentor?  @relation(fields: [mentorId], references: [userId], onDelete: Cascade)

  @@index([buyerId])
  @@index([itemId])
  @@index([mentorId])
}

/// ERD: Mentee sends Requests, Mentor receives Requests
model Request {
  id              Int       @id @default(autoincrement())
  requestStatus   String
  requestSent     DateTime  @default(now())
  requestReceived DateTime?
  mentorId        Int
  menteeId        Int
  mentee          Mentee    @relation(fields: [menteeId], references: [userId], onDelete: Cascade)
  mentor          Mentor    @relation(fields: [mentorId], references: [userId], onDelete: Cascade)

  @@index([mentorId])
  @@index([menteeId])
}

/// Task management for students
model Task {
  id        Int      @id @default(autoincrement())
  title     String
  date      String
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
}

/// Notifications for user activities
model Notification {
  id        Int      @id @default(autoincrement())
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  data      String?
  createdAt DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}
